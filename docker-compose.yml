services:
  # Gateway instances (2 for distributed testing)
  gateway-1:
    build: ./gateway
    ports:
      - "5000:5000"
    volumes:
      - ./keys:/app/keys:ro
    depends_on:
      - service-a
      - service-b
      - service-c
      - redis
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  gateway-2:
    build: ./gateway
    ports:
      - "5001:5000"
    volumes:
      - ./keys:/app/keys:ro
    depends_on:
      - service-a
      - service-b
      - service-c
      - redis
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Backend services
  service-a:
    build: ./services/service-a
    ports:
      - "6000:6000"

  service-b:
    build: ./services/service-b
    ports:
      - "6001:6001"

  service-c:
    build: ./services/service-c
    ports:
      - "6002:6002"

  # Infrastructure
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    depends_on:
      - gateway-1
      - gateway-2
